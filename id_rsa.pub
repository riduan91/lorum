rowNr = func.row_number().over(
        partition_by=[agg.c.strInvestedInPortfID, agg.c.strReportPeriod],
        order_by=[
            desc(agg.c.strInvestedInPortfID),
            desc(agg.c.strReportPeriod),
            desc(internal.c.datACCDate),
            desc(internal.c.numActifNetTotalOpcvm),
        ],
    ).label("rowNr")

    invested_subq = (
        select(
            agg.c.strInvestedInPortfID,
            agg.c.strReportPeriod,
            agg.c.datHoldDate,
            internal.c.datACCDate,
            internal.c.strPortfISOCur.label("strPortfISOCurH"),
            internal.c.numActifNetTotalOpcvm,
            rowNr,
        )
        .select_from(agg.join(internal, agg.c.strInvestedInPortfID == internal.c.strPortfGPSCode))
        .where(internal.c.datACCDate <= agg.c.datHoldDate)
    ).subquery("investedPortfInternal")

    final_sel = select(invested_subq).where(invested_subq.c.rowNr == 1)
