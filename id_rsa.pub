J["daysDiff"] = np.where(
        J["datInstMaturityDate"] <= J["datPeriodLastDay"],
        0,  # Maturity already passed
        np.where(
            (J["blncall"].fillna(0) == 1) & J["datInstCallDate"].notna(),
            # Use explicit datetime conversion to match SQL DATEDIFF behavior
            (pd.to_datetime(J["datInstCallDate"]) - pd.to_datetime(J["datPeriodLastDay"])).dt.days,
            (pd.to_datetime(J["datInstMaturityDate"]) - pd.to_datetime(J["datPeriodLastDay"])).dt.days,
        ),
    )

    # weighted coupon and maturity-days
    J["wCoupon"] = J["numInstCouponRate"] * J["numInstrWeight"]
    J["wMatDays"] = J["daysDiff"] * J["numInstrWeight"]
